#!/usr/bin/env bash

################################################################################
# For keysym names:
# https://cgit.freedesktop.org/xorg/proto/x11proto/tree/keysymdef.h

################################################################################
function kbd() {
  local key=$1
  shift

  hc keybind Mod4-"$key" "$@"
}

################################################################################
# Start from a clean slate:
hc keyunbind --all
hc mouseunbind --all

################################################################################
# Mouse:
hc mousebind Mod4-Button1 move
hc mousebind Mod4-Button2 zoom
hc mousebind Mod4-Button3 resize

################################################################################
# Windows and frames:
kbd k focus up
kbd j focus down
kbd l focus right
kbd h focus left

kbd Control-k focus --level=all up
kbd Control-j focus --level=all down
kbd Control-l focus --level=all right
kbd Control-h focus --level=all left

kbd Shift-k shift up
kbd Shift-j shift down
kbd Shift-l shift right
kbd Shift-h shift left

kbd Control-Shift-k shift --level=all up
kbd Control-Shift-j shift --level=all down
kbd Control-Shift-l shift --level=all right
kbd Control-Shift-j shift --level=all left

kbd Alt-k split top 0.5
kbd Alt-j split bottom 0.5
kbd Alt-l split right 0.5
kbd Alt-h split left 0.5
kbd s split auto 0.5
kbd Alt-s split explode

kbd Control-Alt-k resize up +0.02
kbd Control-Alt-j resize down +0.02
kbd Control-Alt-l resize right +0.02
kbd Control-Alt-h resize left +0.02

kbd m attr clients.focus.minimized true
kbd Shift-m jumpto last-minimized

kbd Shift-s attr clients.focus.pseudotile toggle
kbd t attr clients.focus.floating toggle
kbd c spawn "$HLWMRC_BIN/hlwm-zoom.sh"
kbd F11 attr clients.focus.fullscreen toggle

kbd grave cycle
kbd Tab cycle_monitor

kbd q close_or_remove
kbd u jumpto urgent

# Focus the last floating window on the current tag:
kbd r \
  foreach CLIENT clients. \
  sprintf FLOATING "%c.floating" CLIENT \
  sprintf TAG "%{%c.tag}" CLIENT try and \
  , compare FLOATING = true \
  , compare tags.focus.name = TAG \
  , sprintf WID "%{%c.winid}" CLIENT jumpto WID

################################################################################
# Layout and tweaks:
kbd g set_layout grid
kbd f set_layout max

# Cycle layouts:
kbd BackSpace \
  or , and \
  . compare tags.focus.curframe_wcount = 2 \
  . cycle_layout +1 vertical horizontal max \
  , cycle_layout +1

# Use a predefined layout:
kbd Alt-1 spawn "$HLWMRC_BIN/hlwm-layout-columns.sh" 1
kbd Alt-2 spawn "$HLWMRC_BIN/hlwm-layout-columns.sh" 2
kbd Alt-3 spawn "$HLWMRC_BIN/hlwm-layout-columns.sh" 3

################################################################################
# Tags (workspaces/desktops):
kbd apostrophe use_previous

tag_indexes=({1..10})

for index in "${tag_indexes[@]}"; do
  if [ "$index" -eq 10 ]; then
    key=0
  else
    key=$index
  fi

  # Switch to a tag appropriate for the current monitor:
  kbd "$key" or \
    CASE and . compare monitors.focus.index = 0 . use_index "$((index - 1))" \
    CASE use_index "$((index + 9))"

  # Move the focused window to a tag on the current monitor:
  kbd "Shift-$key" or \
    CASE and . compare monitors.focus.index = 0 . move_index "$((index - 1))" \
    CASE move_index "$((index + 9))"

  # Move the focused window to a tag on the other monitor:
  kbd "Control-$key" or \
    CASE and . compare monitors.focus.index = 0 . move_index "$((index + 9))" \
    CASE move_index "$((index - 1))"
done

################################################################################
# Monitors:
kbd period focus_monitor +1
kbd comma focus_monitor -1

kbd d \
  substitute MON monitors.focus.index \
  substitute SWAP settings.swap_monitors_to_get_tag chain \
  + lock \
  + attr settings.swap_monitors_to_get_tag on \
  + focus_monitor +1 \
  + substitute TAG monitors.focus.tag chain \
  - focus_monitor MON \
  - use TAG \
  - attr settings.swap_monitors_to_get_tag SWAP \
  - unlock

################################################################################
# Launching things:
kbd space spawn rofi-launcher.sh
kbd e spawn e -c
#kbd Return spawn konsole

# Lock the screen:
hc keybind Cancel spawn loginctl lock-session

# Control gromit-mpx:
hc keybind F7 spawn gromit-mpx --clear
hc keybind F8 spawn gromit-mpx-toggle.sh
